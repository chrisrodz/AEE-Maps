$(function() {
    var renderMap = function() {
        $.getJSON('/', function(data){
            $('#map').empty();

            var munidata = [{"municipality":"Adjuntas","founded":"1815","population":"19143","fips":"1","wikipath":"/wiki/Adjuntas,_Puerto_Rico","white":"93.1","black":"3.1","amerindian":"0.3","asian":"0","multiracial":"3.4","hispanic":"99.6","party":"PNP"},{"municipality":"Aguada","founded":"1508","population":"42042","fips":"3","wikipath":"/wiki/Aguada,_Puerto_Rico","white":"86.6","black":"5.3","amerindian":"0.3","asian":"0.1","multiracial":"7.7","hispanic":"99.4","party":"PPD"},{"municipality":"Aguadilla","founded":"1780","population":"64685","fips":"5","wikipath":"/wiki/Aguadilla,_Puerto_Rico","white":"83","black":"7.4","amerindian":"0.3","asian":"0.2","multiracial":"8.2","hispanic":"98.5","party":"PNP"},{"municipality":"Aguas Buenas","founded":"1838","population":"29032","fips":"7","wikipath":"/wiki/Aguas_Buenas,_Puerto_Rico","white":"72.5","black":"12.6","amerindian":"0.6","asian":"0.1","multiracial":"14.2","hispanic":"99.5","party":"PPD"},{"municipality":"Aibonito","founded":"1824","population":"26493","fips":"9","wikipath":"/wiki/Aibonito,_Puerto_Rico","white":"83.5","black":"7.3","amerindian":"0.2","asian":"0","multiracial":"9","hispanic":"99.3","party":"PNP"},{"municipality":"Añasco","founded":"1733","population":"28348","fips":"11","wikipath":"/wiki/A%C3%B1asco,_Puerto_Rico","white":"53.5","black":"32.5","amerindian":"0.9","asian":"0.2","multiracial":"13","hispanic":"99.1","party":"PPD"},{"municipality":"Arecibo","founded":"1616","population":"100131","fips":"13","wikipath":"/wiki/Arecibo,_Puerto_Rico","white":"82","black":"7.2","amerindian":"0.4","asian":"0.1","multiracial":"10.3","hispanic":"99.2","party":"PNP"},{"municipality":"Arroyo","founded":"1855","population":"19117","fips":"15","wikipath":"/wiki/Arroyo,_Puerto_Rico","white":"84.5","black":"6.1","amerindian":"0.4","asian":"0.1","multiracial":"7.9","hispanic":"99.2","party":"PPD"},{"municipality":"Barceloneta","founded":"1881","population":"22322","fips":"17","wikipath":"/wiki/Barceloneta,_Puerto_Rico","white":"80.7","black":"7.6","amerindian":"0.3","asian":"0.1","multiracial":"11.2","hispanic":"99.4","party":"PPD"},{"municipality":"Barranquitas","founded":"1803","population":"28909","fips":"19","wikipath":"/wiki/Barranquitas,_Puerto_Rico","white":"86","black":"5.4","amerindian":"0.3","asian":"0","multiracial":"8.3","hispanic":"99.3","party":"PNP"},{"municipality":"Bayamón","founded":"1772","population":"208116","fips":"21","wikipath":"/wiki/Bayam%C3%B3n,_Puerto_Rico","white":"78.3","black":"10.3","amerindian":"0.6","asian":"0.2","multiracial":"10.7","hispanic":"99","party":"PNP"},{"municipality":"Cabo Rojo","founded":"1771","population":"50917","fips":"23","wikipath":"/wiki/Cabo_Rojo,_Puerto_Rico","white":"84.1","black":"5.4","amerindian":"0.3","asian":"0.1","multiracial":"10.1","hispanic":"98.9","party":"PPD"},{"municipality":"Caguas","founded":"1775","population":"142893","fips":"25","wikipath":"/wiki/Caguas,_Puerto_Rico","white":"76.1","black":"11","amerindian":"0.6","asian":"0.2","multiracial":"12.1","hispanic":"99.1","party":"PPD"},{"municipality":"Camuy","founded":"1807","population":"35159","fips":"27","wikipath":"/wiki/Camuy,_Puerto_Rico","white":"87.9","black":"4.1","amerindian":"0.3","asian":"0.1","multiracial":"7.6","hispanic":"99.4","party":"PNP"},{"municipality":"Canóvanas","founded":"1909","population":"47648","fips":"29","wikipath":"/wiki/Can%C3%B3vanas,_Puerto_Rico","white":"61.2","black":"21.6","amerindian":"0.9","asian":"0.2","multiracial":"16.1","hispanic":"99.2","party":"PNP"},{"municipality":"Carolina","founded":"1816","population":"176762","fips":"31","wikipath":"/wiki/Carolina,_Puerto_Rico","white":"64.3","black":"22.8","amerindian":"0.9","asian":"0.4","multiracial":"11.7","hispanic":"98.6","party":"PPD"},{"municipality":"Cataño","founded":"1927","population":"28140","fips":"33","wikipath":"/wiki/Cata%C3%B1o,_Puerto_Rico","white":"70.7","black":"14.4","amerindian":"1","asian":"0.3","multiracial":"13.7","hispanic":"99","party":"PPD"},{"municipality":"Cayey","founded":"1773","population":"48119","fips":"35","wikipath":"/wiki/Cayey,_Puerto_Rico","white":"79.9","black":"8.3","amerindian":"0.4","asian":"0.1","multiracial":"11.3","hispanic":"99.3","party":"PPD"},{"municipality":"Ceiba","founded":"1838","population":"13631","fips":"37","wikipath":"/wiki/Ceiba,_Puerto_Rico","white":"70.6","black":"16.5","amerindian":"0.7","asian":"0.1","multiracial":"12","hispanic":"98.8","party":"PNP"},{"municipality":"Ciales","founded":"1820","population":"18782","fips":"39","wikipath":"/wiki/Ciales,_Puerto_Rico","white":"89.5","black":"4.2","amerindian":"0.1","asian":"0","multiracial":"6.2","hispanic":"99.7","party":"PPD"},{"municipality":"Cidra","founded":"1809","population":"43480","fips":"41","wikipath":"/wiki/Cidra,_Puerto_Rico","white":"76.6","black":"8.3","amerindian":"0.4","asian":"0.1","multiracial":"14.6","hispanic":"99.4","party":"PNP"},{"municipality":"Coamo","founded":"1579","population":"40512","fips":"43","wikipath":"/wiki/Coamo,_Puerto_Rico","white":"76.8","black":"10.4","amerindian":"0.3","asian":"0.1","multiracial":"12.3","hispanic":"99.6","party":"PPD"},{"municipality":"Comerío","founded":"1826","population":"20778","fips":"45","wikipath":"/wiki/Comer%C3%ADo,_Puerto_Rico","white":"78.6","black":"8.6","amerindian":"0.6","asian":"0.1","multiracial":"12.1","hispanic":"99.6","party":"PPD"},{"municipality":"Corozal","founded":"1795","population":"37142","fips":"47","wikipath":"/wiki/Corozal,_Puerto_Rico","white":"85.4","black":"5.3","amerindian":"0.2","asian":"0.1","multiracial":"9","hispanic":"99.4","party":"PPD"},{"municipality":"Culebra","founded":"1880","population":"1818","fips":"49","wikipath":"/wiki/Culebra,_Puerto_Rico","white":"56.9","black":"26.6","amerindian":"0.9","asian":"0.2","multiracial":"15.4","hispanic":"91.7","party":"PPD"},{"municipality":"Dorado","founded":"1842","population":"38165","fips":"51","wikipath":"/wiki/Dorado,_Puerto_Rico","white":"69.5","black":"15.7","amerindian":"0.7","asian":"0.2","multiracial":"13.9","hispanic":"98","party":"PPD"},{"municipality":"Fajardo","founded":"1772","population":"36993","fips":"53","wikipath":"/wiki/Fajardo,_Puerto_Rico","white":"64.8","black":"18.6","amerindian":"0.7","asian":"0.3","multiracial":"15.7","hispanic":"98.2","party":"PNP"},{"municipality":"Florida","founded":"1971","population":"12680","fips":"54","wikipath":"/wiki/Florida,_Puerto_Rico","white":"90.4","black":"4.6","amerindian":"0.3","asian":"0.1","multiracial":"4.5","hispanic":"99.6","party":"PNP"},{"municipality":"Guánica","founded":"1508","population":"19427","fips":"55","wikipath":"/wiki/Gu%C3%A1nica,_Puerto_Rico","white":"72.5","black":"14.6","amerindian":"0.4","asian":"0.1","multiracial":"12.5","hispanic":"99.2","party":"PNP"},{"municipality":"Guayama","founded":"1736","population":"45362","fips":"57","wikipath":"/wiki/Guayama,_Puerto_Rico","white":"79.9","black":"7.7","amerindian":"0.5","asian":"0","multiracial":"11.8","hispanic":"99.4","party":"PPD"},{"municipality":"Guayanilla","founded":"1833","population":"21581","fips":"59","wikipath":"/wiki/Guayanilla,_Puerto_Rico","white":"68.2","black":"18.5","amerindian":"0.8","asian":"0.1","multiracial":"12.3","hispanic":"99.1","party":"PPD"},{"municipality":"Guaynabo","founded":"1769","population":"97924","fips":"61","wikipath":"/wiki/Guaynabo,_Puerto_Rico","white":"81.9","black":"8.3","amerindian":"0.4","asian":"0.1","multiracial":"9.3","hispanic":"99.5","party":"PNP"},{"municipality":"Gurabo","founded":"1815","population":"45369","fips":"63","wikipath":"/wiki/Gurabo,_Puerto_Rico","white":"79.4","black":"9.8","amerindian":"0.4","asian":"0.2","multiracial":"10.1","hispanic":"98.2","party":"PNP"},{"municipality":"Hatillo","founded":"1823","population":"41953","fips":"65","wikipath":"/wiki/Hatillo,_Puerto_Rico","white":"87.3","black":"4.4","amerindian":"0.2","asian":"0.1","multiracial":"8","hispanic":"99.2","party":"PPD"},{"municipality":"Hormigueros","founded":"1874","population":"17250","fips":"67","wikipath":"/wiki/Hormigueros,_Puerto_Rico","white":"81.2","black":"8.3","amerindian":"0.4","asian":"0.1","multiracial":"10","hispanic":"99.5","party":"PPD"},{"municipality":"Humacao","founded":"1722","population":"58466","fips":"69","wikipath":"/wiki/Humacao,_Puerto_Rico","white":"66.1","black":"18.5","amerindian":"0.8","asian":"0.2","multiracial":"14.3","hispanic":"99","party":"PPD"},{"municipality":"Isabela","founded":"1819","population":"45631","fips":"71","wikipath":"/wiki/Isabela,_Puerto_Rico","white":"83.4","black":"7.5","amerindian":"0.3","asian":"0.1","multiracial":"8.6","hispanic":"99","party":"PPD"},{"municipality":"Jayuya","founded":"1911","population":"16642","fips":"73","wikipath":"/wiki/Jayuya,_Puerto_Rico","white":"90.7","black":"3.4","amerindian":"0.4","asian":"0.1","multiracial":"5.5","hispanic":"99.6","party":"PPD"},{"municipality":"Juana Díaz","founded":"1798","population":"50747","fips":"75","wikipath":"/wiki/Juana_D%C3%ADaz,_Puerto_Rico","white":"75.3","black":"14.3","amerindian":"0.5","asian":"0.1","multiracial":"9.9","hispanic":"99.4","party":"PPD"},{"municipality":"Juncos","founded":"1797","population":"40290","fips":"77","wikipath":"/wiki/Juncos,_Puerto_Rico","white":"71.7","black":"13.7","amerindian":"0.5","asian":"0.1","multiracial":"14.1","hispanic":"99.3","party":"PPD"},{"municipality":"Lajas","founded":"1883","population":"25753","fips":"79","wikipath":"/wiki/Lajas,_Puerto_Rico","white":"80.6","black":"5.2","amerindian":"0.2","asian":"0.1","multiracial":"13.9","hispanic":"99.3","party":"PPD"},{"municipality":"Lares","founded":"1827","population":"30753","fips":"81","wikipath":"/wiki/Lares,_Puerto_Rico","white":"91.1","black":"3","amerindian":"0.2","asian":"0.1","multiracial":"5.6","hispanic":"99.3","party":"PNP"},{"municipality":"Las Marías","founded":"1871","population":"9881","fips":"83","wikipath":"/wiki/Las_Mar%C3%ADas,_Puerto_Rico","white":"86.3","black":"5.3","amerindian":"0.4","asian":"0","multiracial":"8","hispanic":"99.4","party":"PPD"},{"municipality":"Las Piedras","founded":"1773","population":"38675","fips":"85","wikipath":"/wiki/Las_Piedras,_Puerto_Rico","white":"70.5","black":"11.8","amerindian":"0.5","asian":"0.1","multiracial":"17.1","hispanic":"99.4","party":"PNP"},{"municipality":"Loíza","founded":"1719","population":"30060","fips":"87","wikipath":"/wiki/Lo%C3%ADza,_Puerto_Rico","white":"26.5","black":"64.3","amerindian":"0.5","asian":"0.1","multiracial":"8.6","hispanic":"99.4","party":"PNP"},{"municipality":"Luquillo","founded":"1797","population":"20068","fips":"89","wikipath":"/wiki/Luquillo,_Puerto_Rico","white":"65.5","black":"20.8","amerindian":"0.9","asian":"0.2","multiracial":"12.6","hispanic":"97.9","party":"PPD"},{"municipality":"Manatí","founded":"1738","population":"44113","fips":"91","wikipath":"/wiki/Manat%C3%AD,_Puerto_Rico","white":"81.8","black":"8.7","amerindian":"0.5","asian":"0.1","multiracial":"8.9","hispanic":"99.2","party":"PNP"},{"municipality":"Maricao","founded":"1874","population":"6276","fips":"93","wikipath":"/wiki/Maricao,_Puerto_Rico","white":"89.2","black":"4.8","amerindian":"0.4","asian":"0","multiracial":"5.3","hispanic":"99.4","party":"PNP"},{"municipality":"Maunabo","founded":"1799","population":"12225","fips":"95","wikipath":"/wiki/Maunabo,_Puerto_Rico","white":"47.9","black":"30.4","amerindian":"0.8","asian":"0.1","multiracial":"20.8","hispanic":"99.2","party":"PPD"},{"municipality":"Mayagüez","founded":"1760","population":"89080","fips":"97","wikipath":"/wiki/Mayag%C3%BCez,_Puerto_Rico","white":"78.7","black":"8.2","amerindian":"0.8","asian":"0.2","multiracial":"12.1","hispanic":"98.9","party":"PPD"},{"municipality":"Moca","founded":"1772","population":"40109","fips":"99","wikipath":"/wiki/Moca,_Puerto_Rico","white":"89.5","black":"4.5","amerindian":"0.2","asian":"0.1","multiracial":"5.8","hispanic":"99.4","party":"PNP"},{"municipality":"Morovis","founded":"1818","population":"32610","fips":"101","wikipath":"/wiki/Morovis,_Puerto_Rico","white":"88.4","black":"5.2","amerindian":"0.2","asian":"0.1","multiracial":"6.1","hispanic":"99.4","party":"PNP"},{"municipality":"Naguabo","founded":"1821","population":"26720","fips":"103","wikipath":"/wiki/Naguabo,_Puerto_Rico","white":"71.1","black":"15.9","amerindian":"0.4","asian":"0.2","multiracial":"12.4","hispanic":"99.2","party":"PNP"},{"municipality":"Naranjito","founded":"1824","population":"30402","fips":"105","wikipath":"/wiki/Naranjito,_Puerto_Rico","white":"84.2","black":"6","amerindian":"0.5","asian":"0.1","multiracial":"9.4","hispanic":"99.5","party":"PNP"},{"municipality":"Orocovis","founded":"1772","population":"23423","fips":"107","wikipath":"/wiki/Orocovis,_Puerto_Rico","white":"86.7","black":"6.2","amerindian":"0.4","asian":"0.1","multiracial":"6.6","hispanic":"99.6","party":"PNP"},{"municipality":"Patillas","founded":"1811","population":"19277","fips":"109","wikipath":"/wiki/Patillas,_Puerto_Rico","white":"61.7","black":"19.9","amerindian":"0.6","asian":"0.1","multiracial":"17.7","hispanic":"99.3","party":"PPD"},{"municipality":"Peñuelas","founded":"1793","population":"24282","fips":"111","wikipath":"/wiki/Pe%C3%B1uelas,_Puerto_Rico","white":"81.8","black":"9.2","amerindian":"0.4","asian":"0.2","multiracial":"8.4","hispanic":"99.4","party":"PPD"},{"municipality":"Ponce","founded":"1692","population":"166327","fips":"113","wikipath":"/wiki/Ponce,_Puerto_Rico","white":"82","black":"9","amerindian":"0.5","asian":"0.2","multiracial":"8.3","hispanic":"99.2","party":"PNP"},{"municipality":"Quebradillas","founded":"1823","population":"25919","fips":"115","wikipath":"/wiki/Quebradillas,_Puerto_Rico","white":"89.2","black":"3.7","amerindian":"0.1","asian":"0.1","multiracial":"6.9","hispanic":"99.3","party":"PPD"},{"municipality":"Rincón","founded":"1771","population":"15200","fips":"117","wikipath":"/wiki/Rinc%C3%B3n,_Puerto_Rico","white":"85.7","black":"5.3","amerindian":"0.5","asian":"0.2","multiracial":"8.2","hispanic":"96.4","party":"PPD"},{"municipality":"Río Grande","founded":"1840","population":"54304","fips":"119","wikipath":"/wiki/R%C3%ADo_Grande,_Puerto_Rico","white":"61.9","black":"24.6","amerindian":"0.7","asian":"0.2","multiracial":"12.6","hispanic":"99","party":"PPD"},{"municipality":"Sabana Grande","founded":"1813","population":"25265","fips":"121","wikipath":"/wiki/Sabana_Grande,_Puerto_Rico","white":"85.3","black":"5.5","amerindian":"0.4","asian":"0","multiracial":"8.8","hispanic":"99.5","party":"PPD"},{"municipality":"Salinas","founded":"1851","population":"31078","fips":"123","wikipath":"/wiki/Salinas,_Puerto_Rico","white":"67.4","black":"16.4","amerindian":"0.6","asian":"0.1","multiracial":"15.5","hispanic":"99.3","party":"PPD"},{"municipality":"San Germán","founded":"1573","population":"35527","fips":"125","wikipath":"/wiki/San_Germ%C3%A1n,_Puerto_Rico","white":"83.4","black":"5.6","amerindian":"0.4","asian":"0.1","multiracial":"10.5","hispanic":"99.2","party":"PPD"},{"municipality":"San Juan","founded":"1509","population":"395326","fips":"127","wikipath":"/wiki/San_Juan,_Puerto_Rico","white":"68","black":"18.6","amerindian":"0.8","asian":"0.4","multiracial":"12.2","hispanic":"98.2","party":"PPD"},{"municipality":"San Lorenzo","founded":"1811","population":"41058","fips":"129","wikipath":"/wiki/San_Lorenzo,_Puerto_Rico","white":"76.1","black":"9.9","amerindian":"0.8","asian":"0.1","multiracial":"13.2","hispanic":"99.5","party":"PPD"},{"municipality":"San Sebastián","founded":"1752","population":"42430","fips":"131","wikipath":"/wiki/San_Sebasti%C3%A1n,_Puerto_Rico","white":"88.5","black":"3","amerindian":"0.3","asian":"0.1","multiracial":"8.1","hispanic":"99.3","party":"PNP"},{"municipality":"Santa Isabel","founded":"1842","population":"23274","fips":"133","wikipath":"/wiki/Santa_Isabel,_Puerto_Rico","white":"73","black":"15.6","amerindian":"0.5","asian":"0.1","multiracial":"10.9","hispanic":"99.6","party":"PNP"},{"municipality":"Toa Alta","founded":"1751","population":"74066","fips":"135","wikipath":"/wiki/Toa_Alta,_Puerto_Rico","white":"76.3","black":"9.6","amerindian":"0.4","asian":"0.1","multiracial":"13.5","hispanic":"99.3","party":"PPD"},{"municipality":"Toa Baja","founded":"1745","population":"89609","fips":"137","wikipath":"/wiki/Toa_Baja,_Puerto_Rico","white":"70.2","black":"16.8","amerindian":"0.6","asian":"0.3","multiracial":"12.1","hispanic":"99","party":"PNP"},{"municipality":"Trujillo Alto","founded":"1801","population":"74842","fips":"139","wikipath":"/wiki/Trujillo_Alto,_Puerto_Rico","white":"72.1","black":"14.6","amerindian":"0.7","asian":"0.2","multiracial":"12.3","hispanic":"98.9","party":"PPD"},{"municipality":"Utuado","founded":"1739","population":"33149","fips":"141","wikipath":"/wiki/Utuado,_Puerto_Rico","white":"92.7","black":"2.7","amerindian":"0.2","asian":"0.1","multiracial":"4.3","hispanic":"99.4","party":"PPD"},{"municipality":"Vega Alta","founded":"1775","population":"39951","fips":"143","wikipath":"/wiki/Vega_Alta,_Puerto_Rico","white":"71.2","black":"14.9","amerindian":"0.7","asian":"0.2","multiracial":"13.1","hispanic":"98.7","party":"PNP"},{"municipality":"Vega Baja","founded":"1776","population":"59662","fips":"145","wikipath":"/wiki/Vega_Baja,_Puerto_Rico","white":"77.3","black":"11.5","amerindian":"0.5","asian":"0.1","multiracial":"10.6","hispanic":"99.3","party":"PPD"},{"municipality":"Vieques","founded":"1852","population":"9301","fips":"147","wikipath":"/wiki/Vieques,_Puerto_Rico","white":"58.7","black":"28.1","amerindian":"0.7","asian":"0.1","multiracial":"12.5","hispanic":"94.3","party":"PPD"},{"municipality":"Villalba","founded":"1917","population":"26073","fips":"149","wikipath":"/wiki/Villalba,_Puerto_Rico","white":"82.1","black":"8.5","amerindian":"0.2","asian":"0","multiracial":"9.1","hispanic":"99.7","party":"PPD"},{"municipality":"Yabucoa","founded":"1793","population":"37941","fips":"151","wikipath":"/wiki/Yabucoa,_Puerto_Rico","white":"65.6","black":"14.1","amerindian":"0.5","asian":"0.2","multiracial":"19.8","hispanic":"99.3","party":"PPD"},{"municipality":"Yauco","founded":"1756","population":"42043","fips":"153","wikipath":"/wiki/Yauco,_Puerto_Rico","white":"83","black":"5.9","amerindian":"0.3","asian":"0.1","multiracial":"9.6","hispanic":"99.5","party":"PNP"}];

            _.each(munidata, function(item) {
                var copy = _.find(data, function(_item) { return _item.name.toLowerCase() == item.municipality.toLowerCase(); });

                if (copy) {
                    item.incidents = copy.incidents.length;
                } else {
                    item.incidents = 0;
                }
            });

            var map = new AtlasPR({
                node: $('#map')[0],
                size: 'large',
                tiles: 'pueblos',
                labels: true,
                on_ready: function() {
                    var stateMap = {};

                    _.each(munidata, function(item, index) {
                        item.state = 'excelent';

                        if (item.incidents === 1) {
                            item.state = 'ok';
                        } else if (item.incidents > 1 && item.incidents <= 4) {
                            item.state = 'bad';
                        } else if (item.incidents > 4) {
                            item.state = 'critical';
                        }

                        var fips_3digits = item.fips.length == 1 ? ("00" + item.fips) : (item.fips.length == 2 ? ("0" + item.fips) : item.fips);
                        stateMap[fips_3digits] = item.state;
                    });

                    map.encode_qual(stateMap, {
                        'excelent': '#2ecc71',
                        'ok': '#e67e22',
                        'bad': '#d35400',
                        'critical': '#c0392b'
                    });

                    $('#map').prepend('<h1>Incidentes AEE</h1>');
                }
            });
        });
    };

    renderMap();
});
